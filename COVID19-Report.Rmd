---
title: "COVID19 Case Fatality Rates and Vaccinations"
author: ""
date: "9/11/2021"
header-includes:
- \usepackage{float}
- \floatplacement{figure}{H}
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# COVID-19 Analysis

## Libraries used

- tidyverse
- lubridate
- readr
- scales
- kableExtra
- float

## Datasets

The data sources used in this analysis are available through the [COVID-19 Data Repository](https://github.com/CSSEGISandData/COVID-19) compiled by the Center for Systems Science and Engineering at Johns Hopkins University.

Global Cases and Deaths
[https://github.com/CSSEGISandData/COVID-19](https://github.com/CSSEGISandData/COVID-19)

Global Vaccination Data
[https://github.com/govex/COVID-19/tree/master/data_tables/vaccine_data/us_data](https://github.com/govex/COVID-19/tree/master/data_tables/vaccine_data/us_data)

```{r libraries, echo=FALSE,  message=FALSE}
library(lubridate)
library(tidyverse)
library(readr)
library(scales)
library(kableExtra)
library(float)
```

### Summary

This analysis aims to measure the impact of vaccinations on COVID-19 mortality rates in the United States by comparing deaths per 1000 by state before and after February 1, 2021, which is when the number of individuals vaccinated in the US reportedly exceeded the total number of active cases (source: [Bloomberg](https://www.bloomberg.com/news/articles/2021-02-01/u-s-hits-milestone-in-pandemic-with-more-vaccinated-than-cases)).  This analysis is biased towards vaccinations in the sense that it aims to predict death rates per thousand after February as an outcome of the percentage size of non-vaccinated populations per state.

### Link to Github

The R-Mardkown file used to create this report is available on [Github](https://github.com/clintecum/msds-projects/COVID19-Report.Rmd)

```{r import_data, echo=FALSE, message=FALSE}
base_url="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"
global_population_url="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"

files <- c("time_series_covid19_confirmed_US.csv",
           "time_series_covid19_confirmed_global.csv",
           "time_series_covid19_deaths_US.csv",
           "time_series_covid19_deaths_global.csv")

urls <- str_c(base_url,files)

us_cases <- read_csv(urls[1])
us_deaths <- read_csv(urls[3])

vax_base_url="https://raw.githubusercontent.com/govex/COVID-19/master/data_tables/vaccine_data/us_data/time_series/"

vax_files <- c("people_vaccinated_us_timeline.csv",
           "time_series_covid19_vaccine_doses_admin_US.csv",
           "vaccine_data_us_timeline.csv")

vax_urls <- str_c(vax_base_url,vax_files)

us_vaccinated <- read_csv(vax_urls[1]) %>%
  select(-c(FIPS, Lat, Long_))
```

```{r us_tidy, echo=FALSE, message=FALSE}
us_cases <- us_cases %>%
  pivot_longer(
    cols = -(UID:Combined_Key),
    names_to="date",
    values_to="cases"
  ) %>%
  select(Admin2:cases) %>%
  mutate(date=mdy(date)) %>%
  select(-c(Lat,Long_))

us_deaths <- us_deaths %>%
  pivot_longer(
    cols = -(UID:Population),
    names_to = "date",
    values_to = "deaths"
  ) %>%
  select(Admin2:deaths) %>%
  mutate(date = mdy(date)) %>%
  select(-c(Lat, Long_))

us <- us_cases %>%
  full_join(us_deaths)

# create tables for us totals before January 31, 2021
us_cases_before_vaccine <- us_cases %>%
  filter(date <= as.Date("2021-01-31"))

us_deaths_before_vaccine <- us_deaths %>%
  filter(date <= as.Date("2021-01-31"))

us_before_vaccine <- us_cases_before_vaccine %>%
  full_join(us_deaths_before_vaccine)
```

\newpage
### Analysis

The chart of new COVID-19 cases and deaths in the United States reveals the trajectory of infections and fatalities resulting from COVID-19 from the beginning of the pandemic up to the present.  At a high level, the curve reveals the initial onset of new cases, the short decline during lockdown, the steady rise leading up to the vaccine, another temporary decline in cases and deaths, and finally the return of rising cases and deaths during the Delta variant wave leading up to the present.

```{r us_analysis, echo=FALSE, message=FALSE}
us_by_state <- us %>%
  group_by(Province_State, Country_Region, date) %>%
  summarize(
    cases = sum(cases),
    deaths = sum(deaths),
    Population = sum(Population)
  ) %>%
  mutate(deaths_per_thousand = deaths * 1000 / Population) %>%
  select(Province_State,
         Country_Region,
         date,
         cases,
         deaths,
         deaths_per_thousand,
         Population) %>%
  ungroup()

us_by_state_before_vaccine <- us_before_vaccine %>%
  group_by(Province_State, Country_Region, date) %>%
  summarize(
    cases = sum(cases),
    deaths = sum(deaths),
    Population = sum(Population)
  ) %>%
  mutate(cases_before_vaccine = cases) %>%
  mutate(deaths_before_vaccine = deaths) %>%
  mutate(deaths_per_thousand_before_vaccine = deaths * 1000 / Population) %>%
  select(
    Province_State,
    Country_Region,
    date,
    cases_before_vaccine,
    deaths_before_vaccine,
    deaths_per_thousand_before_vaccine,
    Population
  ) %>%
  ungroup()



us_totals <- us_by_state %>%
  group_by(Country_Region,
           date) %>%
  summarize(
    cases = sum(cases),
    deaths = sum(deaths),
    Population = sum(Population)
  ) %>%
  mutate(
    cases_per_thousand = cases * 1000 / Population,
    deaths_per_thousand = deaths * 1000 / Population,
    case_fatality_rate = deaths / cases * 100
  ) %>%
  select(
    Country_Region,
    date,
    cases,
    cases_per_thousand,
    deaths,
    deaths_per_thousand,
    case_fatality_rate,
    Population
  ) %>%
  ungroup()

us_by_state <- us_by_state %>%
  mutate(new_cases=cases-lag(cases),
         new_deaths=deaths-lag(deaths))

us_totals <- us_totals %>%
  mutate(new_cases=cases-lag(cases),
         new_deaths=deaths-lag(deaths))

```



```{r us_visualizations, echo=FALSE, message=FALSE, warning=FALSE, fig.dim = c(12,8), fig.align="center"}

us_totals %>%
  ggplot(aes(x = date, y = new_cases)) +
  geom_point(na.rm = TRUE) +
  geom_point(aes(color = "new_cases")) +
  geom_point(aes(y = new_deaths, color = "new_deaths")) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.direction = "vertical",
    axis.text.x = element_text(angle = 90),
    legend.text = element_text(size = 14),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4, 4, 4, 4),
    text = element_text(size=16)
  ) +
  labs(title = "New COVID19 Cases and Deaths in the United States", y = NULL, x = NULL) +
  scale_x_date(
    date_breaks = "1 month",
    labels = date_format("%b-%Y"),
    limits = as.Date(c('2020-01-01', '2021-09-13'))
  )
```

\newpage
The shape of the case fatality rate curve raises questions about both early responses to the pandemic as well as the accuracy of reported death tolls caused by COVID-19.  The officially reported numbers of COVID-19 deaths are problematic for several reasons including varying levels of testing capacity, inconsistent approaches to diagnosis, and the metrics of counting comorbidities in patients with pre-existing medical conditions.  One study released by the Institute for Health Metrics and Evaluation at the University of Washington estimates that the excess mortality rate measuring deaths directly or indirectly caused by COVID-19 in the United States could be as much as 50% higher than the officially reported death tolls.  ([source: NPR](https://www.npr.org/sections/coronavirus-live-updates/2021/05/06/994287048/new-study-estimates-more-than-900-000-people-have-died-of-covid-19-in-u-s links to http://www.healthdata.org/special-analysis/estimation-excess-mortality-due-covid-19-and-scalars-reported-covid-19-deaths)).

```{r infection_death_rate, echo=FALSE, message=FALSE, warning=FALSE,fig.dim = c(12,8), fig.align="center"}
us_totals %>%
  ggplot(aes(x = date,
             y = case_fatality_rate)) +
  geom_point(aes(color = "mortality_rate")) +
  theme_bw() +
  theme(
    legend.direction = "vertical",
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 14),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4, 4, 4, 4),
    axis.text.x = element_text(angle = 90),
    text = element_text(size=16)
  ) +
  scale_color_manual(
    labels = c(
      "Case Fatality Rate"
    ),
    values = c("firebrick3")
  ) +
  labs(title = "COVID19 Case Fatality Rate in the United States",x=NULL, y = NULL) +
  scale_x_date(
    date_breaks = "1 month",
    labels = date_format("%b-%Y"),
    limits = as.Date(c('2020-03-01', '2021-09-13'))
  ) +
  scale_y_continuous(limits = c(1, 7), breaks = seq(1, 7, 0.5))
```

\newpage

```{r state_comparisons, echo=FALSE, message=FALSE, warning=FALSE}
us_state_totals <- us_by_state %>%
  group_by(Province_State) %>%
  summarize(deaths=max(deaths),cases=max(cases),population=max(Population),
            cases_per_thousand=1000*cases/population,
            deaths_per_thousand=1000*deaths/population) %>%
  filter(cases>0,population>0)

us_by_state_totals_before_vaccine <- us_by_state_before_vaccine %>%
  group_by(Province_State) %>%
  summarize(deaths_before_vaccine=max(deaths_before_vaccine),
            cases_before_vaccine=max(cases_before_vaccine)) %>%
  filter(cases_before_vaccine>0) %>%
  select(c(Province_State, cases_before_vaccine, deaths_before_vaccine))

us_by_state_totals_after_vaccine <- us_state_totals %>%
  full_join(us_by_state_totals_before_vaccine) %>%
  mutate(deaths_per_thousand_before_vaccine=1000*deaths_before_vaccine/population) %>%
  mutate(cases_after_vaccine=cases-cases_before_vaccine) %>%
  mutate(deaths_after_vaccine=deaths-deaths_before_vaccine) %>%
  mutate(cases=cases_after_vaccine) %>%
  mutate(deaths=deaths_after_vaccine) %>%
  mutate(cases_per_thousand=1000*cases/population) %>%
  mutate(deaths_per_thousand=1000*deaths/population) %>%
  select(c(Province_State, cases, cases_per_thousand, deaths, deaths_per_thousand, population,deaths_per_thousand_before_vaccine))

us_state_min_totals <- us_state_totals %>%
  filter(deaths > 300) %>%
  slice_min(deaths_per_thousand,n=50) %>%
  arrange(desc(deaths_per_thousand)) %>%
  rename(State=Province_State) %>%
  rename(Population=population) %>%
  rename(`Total Deaths`=deaths) %>%
  rename(`Deaths per 1,000`=deaths_per_thousand) %>%
  select(c(State, `Deaths per 1,000`, `Total Deaths`, Population))


us_state_max_totals <- us_state_totals %>%
  slice_max(deaths_per_thousand,n=25)

```
\newpage
```{r name, echo=FALSE, message=TRUE}
kable(
  us_state_min_totals,
  align = "lccc",
  digits = 1,
  linesep = "",
  format="latex",
  format.args = list(big.mark = ","),
  caption = "COVID19 Death Rates by State",
  booktabs = T
) %>%
  kable_styling(latex_options=c("striped", "HOLD_position"), position="center") %>%
  column_spec(column = 1, width = "3.5cm") %>%
  column_spec(column = 2, width = "3cm") %>%
  column_spec(column = 3, width = "3cm") %>%
  column_spec(column = 4, width = "3cm")
```
\newpage
```{r death_rates_before_and_after_feb1_table ,echo=FALSE, message=FALSE, fig.dim = c(8, 10), fig.align="center"}
post_vaccine_table <- us_by_state_totals_after_vaccine %>%
  filter(deaths>300) %>%
  select(c(Province_State, deaths_per_thousand_before_vaccine, deaths_per_thousand)) %>%
  arrange(desc(deaths_per_thousand))
kable(
  post_vaccine_table,
  align = "lcc",
  digits = 1,
  linesep = "",
  format="latex",
  format.args = list(big.mark = ","),
  col.names = c("State", "Before Feb. 1, 2021", "After Feb. 1, 2021"),
  caption = "COVID19 Death Rates Before and After Vaccine Rollout",
  booktabs = T
) %>%
  kable_styling(latex_options=c("striped","HOLD_position"), position="center") %>%
  column_spec(column = 1, width = "3.5cm") %>%
  column_spec(column = 2, width = "3cm") %>%
  column_spec(column = 3, width = "3cm")
```

\newpage

```{r import_vaccine_data, echo=FALSE,message=FALSE,warning=FALSE}
us_by_state_with_vaccinations <- us_by_state %>%
  left_join(us_vaccinated, by=c("Province_State")) %>%
  filter(cases>0,Population>0) %>%
  replace_na(list(People_Partially_Vaccinated = 0,People_Fully_Vaccinated =0)) %>%
  mutate(unvaccinated=Population-People_Partially_Vaccinated-People_Fully_Vaccinated) %>%
  select(-c(Combined_Key, deaths_per_thousand))


us_vaccination_totals <- us_by_state_with_vaccinations %>%
  group_by(Province_State) %>%
  summarize(
    deaths = max(deaths),
    cases = max(cases),
    population = max(Population),
    partially_vaccinated = max(People_Partially_Vaccinated),
    fully_vaccinated = max(People_Fully_Vaccinated),
    unvaccinated = population - fully_vaccinated - partially_vaccinated,
    percent_unvaccinated = unvaccinated / population * 100,
    percent_fully_vaccinated = fully_vaccinated / population * 100,
    percent_partially_vaccinated = partially_vaccinated / population * 100,
    cases_per_thousand = 1000 * cases / population,
    deaths_per_thousand = 1000 * deaths / population
  ) %>%
  filter(cases > 0, population > 0)

us_vaccination_totals_with_post_vaccine_data <-
  us_vaccination_totals %>%
  select(c(Province_State, unvaccinated)) %>%
  full_join(us_by_state_totals_after_vaccine) %>%
  select(c(Province_State, unvaccinated, cases, deaths, population)) %>%
  filter(cases > 0, population > 0) %>%
  mutate(unvaccinated_per_thousand = 1000 * unvaccinated / population) %>%
  mutate(cases_per_thousand = 1000 * cases / population) %>%
  mutate(deaths_per_thousand = 1000 * deaths / population)

us_state_vaccinations_max_totals <- us_vaccination_totals %>%
  select(c(Province_State,population,unvaccinated,percent_unvaccinated,deaths_per_thousand)) %>%
  slice_max(percent_unvaccinated,n=55)

```
\newpage
```{r vaccinate_rates_table ,echo=FALSE,message=FALSE, fig.dim = c(8, 10), fig.align="center"}
vax_table <- us_vaccination_totals %>%
  filter(deaths > 300) %>%
  select(
    c(
      Province_State,
      percent_unvaccinated ,
      percent_fully_vaccinated,
      percent_partially_vaccinated,
      deaths_per_thousand
    )
  ) %>%
  slice_max(percent_unvaccinated,n=50) %>%
  arrange(desc(percent_unvaccinated))
kable(
  vax_table,
  align = "lcccc",
  digits = 1,
  linesep = "",
  format = "latex",
  format.args = list(big.mark = ","),
  col.names = c(
    "State",
    "Unvaccinated",
    "Fully Vaccinated",
    "Partially Vaccinated",
    "Deaths per 1,000"
  ),
  caption = "Percent of Population Unvaccinated, Vaccinated and Partially Vaccinated",
  booktabs = T
) %>%
  kable_styling(latex_options = c("striped","HOLD_position"), position = "center") %>%
  column_spec(column = 1, width = "3.3cm") %>%
  column_spec(column = 2, width = "2.8cm") %>%
  column_spec(column = 3, width = "2.8cm") %>%
  column_spec(column = 4, width = "3.1cm") %>%
  column_spec(column = 5, width = "2.8cm")
```

```{r vaccination_data_models, echo=FALSE, warnings=FALSE, message=FALSE}
cases_and_deaths_model <- lm(deaths_per_thousand ~ cases_per_thousand, data=us_state_totals)

us_state_totals_with_predictions <- us_state_totals %>%
  mutate(pred_deaths_per_1000 = predict(cases_and_deaths_model))

vaccines_and_deaths_model <- lm(deaths_per_thousand ~ percent_unvaccinated, data=us_vaccination_totals)

vaccines_and_deaths_since_feb_model <- lm(deaths_per_thousand ~ unvaccinated_per_thousand, data=us_vaccination_totals_with_post_vaccine_data)

us_vaccination_totals_with_post_vaccine_data_and_predictions <- us_vaccination_totals_with_post_vaccine_data %>%
  mutate(pred_deaths_per_1000=predict(vaccines_and_deaths_since_feb_model))

us_vaccination_totals_with_predictions <- us_vaccination_totals %>%
  mutate(pred_deaths_per_1000 = predict(vaccines_and_deaths_model))
```


<!-- \newpage -->

<!-- ```{r vax_totals_with_preds_chart, echo=FALSE, message=FALSE, warning=FALSE, fig.dim = c(10, 7), fig.align="center"} -->
<!-- us_vaccination_totals_with_predictions %>% -->
<!--   ggplot(aes(x = cases_per_thousand, y = deaths_per_thousand)) + -->
<!--   scale_x_continuous(breaks = seq(0, 180, 10)) + -->
<!--   scale_y_continuous(breaks = seq(0, 4, 1)) + -->
<!--   geom_point(aes(color="deaths_per_thousand")) + -->
<!--   geom_point(aes(y=pred_deaths_per_1000, color="pred_deaths_per_1000")) + -->
<!--   theme_bw() + -->
<!--   theme( -->
<!--     legend.direction = "vertical", -->
<!--     legend.position = "bottom", -->
<!--     legend.title = element_blank(), -->
<!--     legend.text = element_text(size = 14), -->
<!--     legend.justification = c("right", "top"), -->
<!--     legend.box.just = "right", -->
<!--     legend.margin = margin(4, 4, 4, 4), -->
<!--     text = element_text(size = 16) -->
<!--   ) + -->
<!--   scale_color_manual( -->
<!--     labels = c( -->
<!--       "Deaths Per Thousand", -->
<!--       "Predicted Deaths Per Thousand" -->
<!--     ), -->
<!--     values = c("gray14", "firebrick3") -->
<!--   ) + -->
<!--   labs(title = "Predicted Death Rates Based on Percent of Unvaccinated Population", y = "Deaths per 1,000", x = "Cases per 1,000") -->

<!-- ``` -->

\newpage

### Data Model Summary
The data model used to calculate predicted death rates in this analysis hypothesizes the number of deaths per thousand for each state as an outcome of the percentage size of a state's non-vaccinated population.  The low p-value returned in the summary data for this model is not surprising but I did find the results interesting in terms of quantifying the impact of vaccinations on COVID-19 death rates.

```{r ggplot_unvaccinated_population_model_predicted_death_rate, echo=FALSE, message=FALSE,fig.dim = c(11, 7), fig.align="center"}
us_vaccination_totals_with_post_vaccine_data_and_predictions %>% 
  ggplot(aes(x = cases_per_thousand, y = deaths_per_thousand)) +
  scale_x_continuous(breaks=seq(0,180,10)) +
  scale_y_continuous(breaks=seq(0,10,1)) +
  geom_point(aes(color="deaths_per_thousand")) +
  geom_point(aes(y=pred_deaths_per_1000, color="pred_deaths_per_1000")) +
  theme_bw() +
  theme(
    legend.direction = "vertical",
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4, 4, 4, 4),
    text = element_text(size = 14)
  ) +
  scale_color_manual(
    labels = c(
      "Deaths Per Thousand",
      "Predicted Deaths Per Thousand"
    ),
    values = c("gray14", "firebrick3")
  ) +
  labs(title = "Predicted Deaths Per 1,000 based on Percent of Unvaccinated Population", y = "Deaths per 1,000", x = "Cases per 1,000")
```


```{r model_predictions_since_feb, echo=FALSE,message=FALSE, fig.dim = c(6, 4), fig.align="center"}
summary(vaccines_and_deaths_since_feb_model)
```


<!-- \newpage -->

<!-- ### model test stepwise linear regression -->

<!-- ```{r model_test, echo=TRUE, warning=FALSE,message=FALSE,fig.dim = c(8, 6), fig.align="center"} -->
<!-- test_data <- us_vaccination_totals_with_post_vaccine_data_and_predictions %>% -->
<!--   select(-c(Province_State)) -->
<!-- base <-lm(deaths_per_thousand ~., test_data) -->
<!-- summary(base) -->

<!-- # vaccines_and_deaths_model <- lm(deaths_per_thousand ~ percent_unvaccinated, data=us_vaccination_totals) -->

<!-- slrFit<-step(base) -->
<!-- slrPredictions<-predict(slrFit, test_data) -->
<!-- slrMSE<-mean((test_data$deaths_per_thousand-slrPredictions)^2) -->
<!-- print(slrMSE) -->
<!-- plot(slrPredictions) -->
<!-- ``` -->
### Session Info

```{r session, echo=FALSE}
sessionInfo()
```

